name: Workspace CI

on:
  pull_request:
    branches: [ "main" ]
env:
  GOTOOLCHAIN: auto

jobs:
  # JOB 1: Detect which modules changed
  module-diff:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.filter.outputs.changes }}
      has_changes: ${{ steps.filter.outputs.changes != '[]' }}
    steps:
      - uses: actions/checkout@v6
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            foundation/api:
              - 'foundation/api/**'
            foundation/gateway:
              - 'foundation/gateway/**'
            foundation/delegator:
              - 'foundation/delegator/**'
            foundation/plugin/aruba:
              - 'foundation/plugin/aruba/**'
            foundation/plugin/ionos:
              - 'foundation/plugin/ionos/**'

  # JOB 2: Generate API artifacts
  generate-api:
    name: Generate API artifacts (always)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'
      - uses: actions/setup-go@v6
        with:
          go-version: '1.24.x'
          cache: true
      - name: Generate API artifacts
        run: |
          make -C foundation/api generate-all

  # JOB 3: Build, Test & Lint
  checks:
    needs: module-diff
    if: needs.module-diff.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.module-diff.outputs.modules) }}
        go: [ "1.24.x" ]

    name: Check (${{ matrix.module }})
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}
          cache: true
          cache-dependency-path: "${{ matrix.module }}/go.sum"

      - name: Run Tests
        run: go test -race -v ./${{ matrix.module }}/...

      - name: GolangCI-Lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          only-new-issues: true
          working-directory: ${{ matrix.module }}
          args: --timeout 10m0s --verbose

  # JOB 4: govulncheck and gosec
  security:
    needs: module-diff
    if: needs.module-diff.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJson(needs.module-diff.outputs.modules) }}
        go: [ "1.24.x" ]
    name: Security (${{ matrix.module }})
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: 'recursive'
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}
          cache: true

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        working-directory: ${{ matrix.module }}
        run: govulncheck ./...

      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./${{ matrix.module }}/...'

  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}